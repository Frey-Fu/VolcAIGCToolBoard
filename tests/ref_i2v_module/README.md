# 参考图生视频模块自动化测试

## 概述

本目录包含参考图生视频模块的自动化测试用例，用于模拟用户在前端页面上传图片并提交任务的完整流程。

## 文件说明

- `test_ref_gen_video.py` - 主要的测试脚本
- `人物 1.jpeg` - 测试用的人物图片1
- `人物 2.jpeg` - 测试用的人物图片2  
- `人物 3.jpeg` - 测试用的人物图片3
- `场景 1.jpeg` - 测试用的场景图片
- `README.md` - 本说明文件

## 测试流程

测试用例会按照以下步骤执行：

1. **检查测试图片文件** - 验证所有必需的测试图片是否存在
2. **上传图片并创建任务** - 模拟前端操作，上传4张图片并提交视频生成任务
3. **查询任务状态** - 持续查询任务状态直到任务完成或失败

## 测试配置

测试使用以下默认配置（模拟前端页面设置）：

- **分辨率**: 480p
- **比例**: 16:9
- **时间**: 3秒
- **随机数种子**: -1
- **生成视频个数**: 2
- **提示词**: "根据参考图片生成高质量视频，保持画面稳定和连贯性"

## 运行测试

### 前提条件

1. 确保服务器正在运行：
   ```bash
   python main_server.py
   ```

2. 服务器默认运行在 `http://localhost:8000`

### 执行测试

在项目根目录下运行：

```bash
# 使用默认服务器地址 (http://localhost:8000)
python tests/ref_gen_video/test_ref_gen_video.py

# 或指定自定义服务器地址
python tests/ref_gen_video/test_ref_gen_video.py http://your-server:port
```

### 测试结果

- **成功**: 退出码为 0，所有步骤都成功完成
- **失败**: 退出码为 1，并输出详细的错误信息

## 日志输出

测试过程中会输出详细的日志信息，包括：

- 测试配置信息
- 图片文件检查结果
- HTTP请求和响应详情
- 任务状态查询进度
- 错误信息（如果有）

## 故障排除

### 常见问题

1. **连接被拒绝**
   - 确保服务器正在运行
   - 检查服务器地址和端口是否正确

2. **图片文件不存在**
   - 确保测试图片文件在正确的目录中
   - 检查文件名是否完全匹配

3. **任务创建失败**
   - 检查API Key配置
   - 查看服务器日志获取详细错误信息

4. **任务状态查询超时**
   - 默认超时时间为10分钟（60次查询 × 10秒间隔）
   - 可以修改测试代码中的 `max_attempts` 和 `interval` 参数

### 调试建议

1. 查看服务器控制台输出获取详细错误信息
2. 检查网络连接和防火墙设置
3. 验证API Key和相关配置是否正确
4. 确保测试图片文件大小在允许范围内

## 扩展测试

可以通过修改 `RefGenVideoTestCase` 类来扩展测试：

- 添加更多测试图片
- 修改测试配置参数
- 增加错误场景测试
- 添加性能测试

## 注意事项

- 测试会实际调用API生成视频，可能产生费用
- 测试图片会被上传到配置的存储服务
- 建议在测试环境中运行，避免影响生产数据